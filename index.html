<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Curah Hujan Kaltim 2024</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root {
      --bg: #EAF3FA;
      --accent: #1E3A8A;
      --muted: #6B7280;
      --card: #ffffff;
    }

    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial;
      background: var(--bg);
      color: rgba(15, 23, 42, 0.95);
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(8, 15, 25, 0.06);
    }

    .muted {
      color: var(--muted);
    }

    .header-blur {
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.7);
    }

    .chart-area {
      height: 320px;
    }

    @media(min-width:1024px) {
      .chart-area {
        height: 380px;
      }
    }
  </style>
</head>

<body>
  <nav class="fixed top-0 left-0 right-0 header-blur border-b border-gray-100 z-40">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img
          src="https://unmul.ac.id/file/image_mod_name/download/YzQzZWZjZWVhODMzNWNhMzhhZjY4YmI1MTVmMWU5OGZlZWMzNDIyNTlmY2NiNzhkM2FkOTA3ODczNzZiZGZiYjg4YTg0Y2Y0NGFkYjMxYjI3YTRhMTA2Y2RhNzI1MWVlNWViNWI2NmIzMGZkMDM4ZjY1NjI1M2M0ZGMwZGEwNGZGaEp6clRNVVN6ZUJGQmxyUm9oaVZwN292c1E9/Logo%20Universitas%20Mulawarman"
          alt="logo" class="h-9 rounded" />
        <div>
          <div class="font-semibold text-gray-900">Curah Hujan Kaltim 2024</div>
          <div class="text-sm muted">Dashboard interaktif. Sumber: BMKG</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="chip text-sm font-semibold text-blue-900 bg-blue-50 px-3 py-1 rounded-full">Periode: 2024</div>
        <button id="downloadBtn" class="text-sm px-3 py-1 rounded border border-gray-200">Download CSV</button>
      </div>
    </div>
  </nav>
  <div class="pt-20"></div>

  <main class="container mx-auto px-6 pb-12">
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <div class="lg:col-span-8 card p-4 lg:p-6">
        <h2 class="text-xl font-semibold mb-4">Peta Interaktif Curah Hujan</h2>
        <div class="w-full h-[620px] rounded overflow-hidden border border-gray-100">
          <iframe id="mapFrame" src="https://khairufadilah.github.io/curah-hujan-kaltim-2024/"
            class="w-full h-full border-0"></iframe>
        </div>
      </div>
      <aside class="lg:col-span-4 flex flex-col gap-6">
        <div class="card p-4">
          <h3 class="font-semibold">Tentang Dashboard</h3>
          <p class="text-sm muted mt-2">Dashboard ini menampilkan data curah hujan Provinsi Kalimantan Timur tahun 2024
            berdasarkan data BMKG. Anda dapat memantau tren, membandingkan stasiun, serta mengunduh visualisasi data.
          </p>
        </div>

        <div class="mt-4 p-6 bg-white rounded shadow w-full">
          <h2 class="text-lg font-semibold mb-4">Curah Hujan Tertinggi</h2>
          <div class="w-full h-[400px]">
            <canvas id="barMaxRain"></canvas>
          </div>
        </div>
      </aside>
    </section>

    <section class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
      <div class="lg:col-span-8 card p-4">
        <h3 class="font-semibold mb-2">Perbandingan Rata-rata Bulanan</h3>
        <div class="chart-area"><canvas id="lineCompare"></canvas></div>
      </div>
      <aside class="lg:col-span-4 flex flex-col gap-6">
        <div class="card p-4">
          <h3 class="font-semibold">Kontrol Cepat</h3>
          <div class="mt-3 grid grid-cols-1 gap-2">
            <div class="text-sm muted">Pilih Stasiun (maks 3)</div>
            <div id="stationList" class="max-h-44 overflow-auto mt-2"></div>
            <div class="flex items-center gap-2 mt-2">
              <button id="selectTop3" class="text-sm px-3 py-1 rounded bg-blue-600 text-white">Pilih 3 Teratas</button>
              <button id="clearSel" class="text-sm px-3 py-1 rounded border">Bersihkan</button>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold">Ringkasan</h3>
          <div class="mt-3 text-sm muted" id="insightBox">Memuat data...</div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold">Unduh & Export</h3>
          <div class="mt-3 text-sm muted">Pilih chart untuk diunduh sebagai gambar atau ekspor semua ke PDF.</div>
          <div class="flex flex-col gap-2 mt-3">
            <button id="choosePNG" class="text-sm px-3 py-1 rounded border">Pilih Chart untuk Export PNG</button>
            <button id="exportPDF" class="text-sm px-3 py-1 rounded border">Export Semua ke PDF</button>
          </div>
        </div>
      </aside>
    </section>
<div id="chartSelectModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-4 w-64 shadow-lg">
    <h3 class="text-lg font-semibold mb-3">Pilih Chart</h3>
    <div class="flex flex-col gap-2">
      <button class="chart-opt bg-blue-500 text-white py-1 rounded" data-chart="line">Line Chart</button>
      <button class="chart-opt bg-blue-500 text-white py-1 rounded" data-chart="bar">Bar Chart</button>
      <button class="chart-opt bg-blue-500 text-white py-1 rounded" data-chart="doughnut">Doughnut Chart</button>
      <button class="chart-opt bg-blue-500 text-white py-1 rounded" data-chart="max">Curah Hujan Tertinggi</button>
    </div>
    <button id="closeChartModal" class="mt-3 text-sm text-gray-500 hover:text-gray-700">Tutup</button>
  </div>
</div>
    <section class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
      <div class="lg:col-span-8 card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Perbandingan per Stasiun</h3>
          <div class="flex items-center gap-3">
            <div id="barSubtitle" class="text-sm muted">Menampilkan Total Bulan</div>
            <select id="monthFilterPanel" class="border rounded p-2 bg-white text-sm"></select>
          </div>
        </div>
        <div class="chart-area"><canvas id="barStation"></canvas></div>
      </div>
      <div class="lg:col-span-4 card p-4">
        <h3 class="font-semibold mb-2">Distribusi Rata-rata</h3>
        <div class="chart-area"><canvas id="doughnutAvg"></canvas></div>
      </div>
    </section>

    <section class="mt-6 card p-4">
      <h3 class="font-semibold mb-3">Data Curah Hujan</h3>
      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full text-sm text-left border border-gray-200 rounded">
          <thead class="bg-blue-50 text-gray-700">
            <tr>
              <th class="px-3 py-2 border">No</th>
              <th class="px-3 py-2 border">Stasiun</th>
              <th class="px-3 py-2 border">Rata-rata (mm)</th>
              <th class="px-3 py-2 border">Total (mm)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-6 text-center text-sm text-gray-500">
      <div class="mb-2 font-semibold text-gray-700">Â© 2025 Universitas Mulawarman</div>
      <div class="muted">Sumber: BMKG. Kontak: info@unmul.ac.id</div>
    </footer>
  </main>

  <script>
    const MONTHS = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let rawData = [], processed = [], lineChart, barChart, doughnutChart, barMaxChart;
    let selectedStations = [];

    async function loadData() {
      try {
        const res = await fetch('curah_hujan_kaltim.json');
        if (!res.ok) throw new Error('Gagal ambil file JSON.');
        rawData = await res.json();

        processed = rawData.map(d => {
          const monthly = MONTHS.map(m => {
            const val = (d[m] || "0").toString().replace(",", ".");
            return parseFloat(val) || 0;
          });
          const total = parseFloat((d["Total"] || "0").toString().replace(",", "."));
          const rata = parseFloat((d["Rata2"] || "0").toString().replace(",", "."));
          return {
            stasiun: (d["Nama Stasiun"] || "Unknown").trim(),
            monthly,
            total: !isNaN(total) ? total : monthly.reduce((a, b) => a + b, 0),
            rata: !isNaN(rata) ? rata : monthly.reduce((a, b) => a + b, 0) / monthly.length
          };
        });

        buildUI();
        renderAll();
        renderMaxRainChart();
        renderTable();
      } catch (e) {
        console.error(e);
        document.getElementById('insightBox').innerText = 'Gagal memuat data. Pastikan file JSON tersedia dan dibuka melalui server.';
      }
    }

    function buildUI() {
      const stList = document.getElementById('stationList');
      stList.innerHTML = '';
      processed.forEach((p, i) => {
        const el = document.createElement('label');
        el.className = 'flex items-center gap-2 p-2 rounded hover:bg-slate-50';
        el.innerHTML = `<input data-idx="${i}" type="checkbox" class="w-4 h-4"><span class="text-sm">${p.stasiun}</span>`;
        stList.appendChild(el);
      });
      document.querySelectorAll('#stationList input[type=checkbox]').forEach(cb => {
        cb.addEventListener('change', onStationToggle);
      });

      const monthSel = document.getElementById('monthFilterPanel');
      if (monthSel) {
        monthSel.innerHTML = MONTHS.map((m, i) => `<option value="${i}">${m}</option>`).join('');
        monthSel.addEventListener('change', () => { renderBarChart(); updateInsight(); });
      }

      // --- AWAL PERBAIKAN: LOGIKA MODAL PNG ---
      const modal = document.getElementById('chartSelectModal');
      const closeBtn = document.getElementById('closeChartModal');
      
      // Tombol untuk MEMBUKA modal
      document.getElementById('choosePNG').addEventListener('click', () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      });

      // Fungsi untuk MENUTUP modal
      const closeModal = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      };

      // Event listener untuk tombol tutup (X)
      closeBtn.addEventListener('click', closeModal);
      
      // Event listener untuk klik di luar modal (area overlay)
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Event listener untuk setiap tombol pilihan chart di dalam modal
      document.querySelectorAll('.chart-opt').forEach(btn => {
        btn.addEventListener('click', () => {
          const chartName = btn.dataset.chart;
          downloadChart(chartName); // Panggil fungsi download baru
          closeModal(); // Tutup modal setelah memilih
        });
      });
      // --- AKHIR PERBAIKAN ---

      document.getElementById('exportPDF').addEventListener('click', exportAllPDF);
      document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
      document.getElementById('selectTop3').addEventListener('click', selectTop3);
      document.getElementById('clearSel').addEventListener('click', clearSelections);
    }

    function onStationToggle(e) {
      const idx = parseInt(e.target.dataset.idx);
      if (e.target.checked) {
        if (selectedStations.length >= 3) {
          e.target.checked = false;
          alert('Maksimal 3 stasiun.');
          return;
        }
        selectedStations.push(idx);
      } else {
        selectedStations = selectedStations.filter(i => i !== idx);
      }
      renderAll();
    }

    function selectTop3() {
      selectedStations = [0, 1, 2].filter(i => i < processed.length);
      document.querySelectorAll('#stationList input[type=checkbox]').forEach((cb, i) => cb.checked = selectedStations.includes(i));
      renderAll();
    }

    function clearSelections() {
      selectedStations = [];
      document.querySelectorAll('#stationList input[type=checkbox]').forEach(cb => cb.checked = false);
      renderAll();
    }

    function getSelectedStations() { return selectedStations.map(i => processed[i]); }

    function renderAll() {
      renderLineChart();
      renderBarChart();
      renderDoughnut();
      updateInsight();
    }

    function renderLineChart() {
      const ctx = document.getElementById('lineCompare');
      if (lineChart) lineChart.destroy();
      const sel = getSelectedStations();
      const datasets = (sel.length ? sel : processed.slice(0, 3)).map((s, idx) => {
        const colors = ['#2563eb', '#06b6d4', '#f97316'];
        return {
          label: s.stasiun,
          data: s.monthly,
          borderColor: colors[idx] || '#7c3aed',
          backgroundColor: (colors[idx] || '#7c3aed') + '22',
          tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 6
        };
      });
      lineChart = new Chart(ctx, {
        type: 'line',
        data: { labels: MONTHS, datasets },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { title: { display: true, text: 'Curah Hujan (mm)' } } } }
      });
    }

    function renderBarChart() {
      const ctx = document.getElementById('barStation');
      if (barChart) barChart.destroy();
      const sel = getSelectedStations();
      const monthVal = parseInt(document.getElementById('monthFilterPanel')?.value) || 0;
      const labels = sel.length ? sel.map(s => s.stasiun) : processed.map(p => p.stasiun);
      const data = (sel.length ? sel : processed).map(p => p.monthly[monthVal]);
      const labelText = 'Curah Hujan ' + MONTHS[monthVal];
      barChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: labelText, data, backgroundColor: generateColors(labels.length) }] },
        options: { responsive: true, plugins: { legend: { display: false } }, indexAxis: 'y' }
      });
    }

    function renderDoughnut() {
      const ctx = document.getElementById('doughnutAvg');
      if (doughnutChart) doughnutChart.destroy();
      const labels = processed.map(p => p.stasiun);
      const data = processed.map(p => p.rata);
      doughnutChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: generateColors(labels.length) }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function shortenStationName(name) {
      if (!name) return name;
      name = name.trim();
      if (name.includes('Meteorologi')) {
        return 'SM ' + name.split(' ').pop();
      } else if (name.includes('Klimatologi')) {
        return 'SK ' + name.split(' ').pop();
      } else if (name.includes('Geofisika')) {
        return 'SG ' + name.split(' ').pop();
      } else {
        return name;
      }
    }

    function renderMaxRainChart() {
      const ctx4 = document.getElementById('barMaxRain').getContext('2d');
      if (barMaxChart) barMaxChart.destroy();

      barMaxChart = new Chart(ctx4, {
        type: 'bar',
        data: {
          labels: processed.map(s => shortenStationName(s.stasiun)),
          datasets: [{
            label: 'Curah Hujan Tertinggi (mm)',
            data: processed.map(s => Math.max(...s.monthly)),
            backgroundColor: '#60a5fa'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'mm' } },
            x: { title: { display: true, text: 'Stasiun' } }
          },
          plugins: {
            legend: { display: false },
            title: { display: false }
          }
        }
      });
    }

    function renderTable() {
      const tbody = document.querySelector('#dataTable tbody');
      if (!tbody) return;
      tbody.innerHTML = processed.map((p, i) => `
    <tr class="hover:bg-slate-50">
      <td class="px-3 py-1 border">${i + 1}</td>
      <td class="px-3 py-1 border">${p.stasiun}</td>
      <td class="px-3 py-1 border text-right">${p.rata.toFixed(1)}</td>
      <td class="px-3 py-1 border text-right">${p.total.toFixed(1)}</td>
    </tr>
  `).join('');
    }

    function updateInsight() {
      const sel = getSelectedStations();
      const div = document.getElementById('insightBox');
      if (sel.length === 0) { div.innerText = 'Pilih hingga 3 stasiun untuk melihat perbandingan.'; return; }
      let txt = '';
      sel.forEach(s => {
        const max = Math.max(...s.monthly);
        const min = Math.min(...s.monthly);
        const bulanMax = MONTHS[s.monthly.indexOf(max)];
        const bulanMin = MONTHS[s.monthly.indexOf(min)];
        txt += `${s.stasiun}: tertinggi ${max.toFixed(1)}mm (${bulanMax}), terendah ${min.toFixed(1)}mm (${bulanMin}), rata-rata ${s.rata.toFixed(1)}mm.\n`;
      });
      div.innerText = txt.trim();
    }

    function generateColors(n) {
      const colors = ['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa', '#f472b6', '#4ade80', '#fb7185', '#7dd3fc'];
      return Array.from({ length: n }, (_, i) => colors[i % colors.length]);
    }

    // --- PERBAIKAN: FUNGSI INI MENGGANTIKAN `chooseChartPNG` LAMA ---
    // Fungsi ini dipanggil oleh tombol-tombol di dalam modal
    function downloadChart(choice) {
      let chart;
      if (choice === 'line') chart = lineChart;
      else if (choice === 'bar') chart = barChart;
      else if (choice === 'doughnut') chart = doughnutChart;
      else if (choice === 'max') chart = barMaxChart;
      else { 
        console.error('Pilihan chart tidak valid:', choice); 
        alert('Pilihan tidak valid.'); 
        return; 
      }
      
      if (!chart) { 
        alert('Chart belum digambar atau tidak ditemukan.'); 
        return; 
      }
      
      const url = chart.toBase64Image();
      const a = document.createElement('a');
      a.href = url; 
      a.download = `chart_${choice}.png`; 
      a.click();
    }

    async function exportAllPDF() {
      // Memerlukan jsPDF. Pastikan sudah di-load.
      if (typeof window.jspdf === 'undefined') {
        alert('Gagal memuat library PDF. Silakan coba lagi.');
        return;
      }

      const pdf = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'px', format: 'a4' });
      const charts = [
        { chart: lineChart, title: 'Perbandingan Rata-rata Bulanan' },
        { chart: barMaxChart, title: 'Curah Hujan Tertinggi' },
        { chart: barChart, title: 'Perbandingan per Stasiun' },
        { chart: doughnutChart, title: 'Distribusi Rata-rata' }
      ];

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 20;
      let y = margin; // Posisi y saat ini

      for (let i = 0; i < charts.length; i++) {
        const c = charts[i];
        if (!c.chart) continue; // Lewati jika chart tidak ada

        const canvas = c.chart.canvas;
        const img = c.chart.toBase64Image();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;

        // Atur ukuran gambar agar pas di halaman
        const maxWidth = pageWidth - 2 * margin;
        const maxHeight = (pageHeight / 2) - (margin * 2); // Targetkan 2 chart per halaman
        let scale = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);

        const drawWidth = imgWidth * scale;
        const drawHeight = imgHeight * scale;

        // Pindah halaman jika tidak cukup ruang
        if (y + drawHeight + 40 > pageHeight && i > 0) {
          pdf.addPage();
          y = margin;
        }

        pdf.setFontSize(14);
        pdf.text(c.title, margin, y);
        pdf.addImage(img, 'PNG', margin, y + 10, drawWidth, drawHeight);
        y += drawHeight + 40; // Spasi untuk chart berikutnya
      }
      pdf.save('Laporan_Curah_Hujan_Kaltim.pdf');
    }


    function downloadCSV() {
      let csv = "Stasiun," + MONTHS.join(",") + ",Total,Rata-rata\n";
      processed.forEach(s => {

        const stasiunName = `"${s.stasiun.replace(/"/g, '""')}"`;
        csv += `${stasiunName},${s.monthly.join(",")},${s.total.toFixed(2)},${s.rata.toFixed(2)}\n`;
      });

      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'curah_hujan_kaltim_2024.csv';
      a.click();
    }

    loadData();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</body>

</html>